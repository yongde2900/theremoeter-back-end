<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溫溼度資料站</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/style.css"> -->
    <style>
        .container{
            height: 100% !important;
            width: 100%!important;
        }
        .p-3 {
            position: relative;
            left:20px;
            width: 150px !important;
            height: 60px !important;
        }
       
        .col {
            width: 80% !important;
            height: 90% !important;
        }

        canvas {
            position: relative;
            left: 10px;
            width: 80% !important;
            height: 80% !important;
        }

        .chart-wrapper {

            display: flex;
            position: relative;

            width: 50%;
            height: 70%;
        }

        div {
            color: rgb(0, 0, 0);
            background-size: 360px 100px;
            border-radius: 25px;
            -webkit-animation: animation;
            animation: animation;
        }

        span {
            position: relative;
            top: 3px;
            left: 12px;
        }

        .animation {
            animation-name: breath;
            animation-duration: 1s;
            animation-timing-function: linear;
            animation-iteration-count: 1;
            animation-delay: 0s;

        }

        @keyframes breath {
            0% {
                background-color: #ffffff;
            }

            50% {
                background-color: #ff5656;
            }

            100% {
                background-color: white;
            }
        }
    </style>

</head>

<body onload="current_time();">
    <div class="container px-4">
        <div class="row gx-5">
            <div class="col">
                <div id="temp" class="p-3 border bg">溫度:</div>
                <canvas id="myChart"></canvas>
            </div>
            <div class="col">
                <div id="humi" class="p-3 border bg">濕度:</div>
                <canvas id="myChart1"></canvas>
            </div>
        </div>
        <!-- <div class="chart-wrapper"> -->
        </div>
    </div>
    </div>
    <span id="current">

         </span>
         <!-- <button class="ck" onclick="addd()">try</button> -->
         

    <!-- <button onclick="addd()">try</button> -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        var ctx = document.getElementById("myChart")
        var ctx1 = document.getElementById("myChart1")
        const labels = ['溫度']
        var chartdata={
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: ['溫度'],
                    data: [20],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',],
                    borderColor: [
                        'rgb(255, 159, 64)',],
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        suggestedMax: 30,
                    }
                }
            },
        }
        var config = new Chart(ctx,chartdata )
        var chartdata2={
            type: 'bar',
            data: {
                labels: ["濕度"],
                datasets: [{
                    label: ['濕度'],
                    data: [20],
                    backgroundColor: [
                        'rgba(255, 159, 64, 0.2)'],
                    borderColor: [
                        'rgb(255, 99, 132)'],
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,

                scales: {
                    y: {
                        suggestedMax: 30,
                    }

                }
            },
        }
        var config2 = new Chart(ctx1,chartdata2 )
    </script>
    
    <script>

        function addd() {
            const el = document.getElementById("temp");
            const el1 = document.getElementById("humi");
            el.style.animation = "breath 1s "
            el1.style.animation = "breath 1s "

            el.addEventListener("animationend", () => {
                el.style.animation = "none"
                el1.style.animation = "none"

                console.log("hi here")
            })

            // el.style.animation("animation");

        }
    </script>
    <script>

        function current_time() {
            document.getElementById("current").innerHTML = new Date();
            setTimeout("current_time()", 1000); //每秒呼叫一次功能:
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.js"
    integrity="sha512-yX4jaiU9Ai9dzaimFoTq+tQYOrAMNP+EWiiUVsru3ypsAi76c0zCPBfxKagLkKjC4ZeLMEQTa7aE7CtjTmlgDA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="module">
    // connect to broker with websocket
    let option = {
        username: 'user',
        password: '123456'
    }
    let client = mqtt.connect('ws://192.168.168.169:1884', option)
    client.on('connect', () => {
        console.log('connected')
        const el = document.getElementById("temp");
        console.log(el)
        client.subscribe('climate/data')
        client.on('message', (topic, payload) => {
            const T = JSON.parse(payload).temperature
            const H = JSON.parse(payload).humidity
            console.log(T, H)
            document.getElementById('temp').innerHTML = `溫度=${T}`
            document.getElementById('humi').innerHTML = `濕度=${H}`
            const el = document.getElementById("temp");
            const el1 = document.getElementById("humi");
            el.style.animation = "breath 1s "
            el1.style.animation = "breath 1s "
            chartdata.data.datasets[0].data[0]=`${T}`
            chartdata2.data.datasets[0].data[0]=`${H}`
            config.update();
            config2.update();
            el.addEventListener("animationend", () => {
                el.style.animation = "none"
                el1.style.animation = "none"
                // console.log("hi here")
            })
        })
    })
</script>
</body>

</html>